---
number: 187
title: "[fpga] timming"
state: open
url: https://github.com/konosubakonoakua/blog/issues/187
author: konosubakonoakua
createdAt: 2025-06-04T00:32:56Z
updatedAt: 2025-10-27T05:08:14Z
labels: []
---

# 187 [fpga] timming

- umbc
  - [robucci cmpeRSD Lecture11__Metastability](https://eclipse.umbc.edu/robucci/cmpeRSD/Lectures/Lecture11__Metastability/)
  - [robucci cmpeRSD Lecture12__ManagingMetaStability](https://eclipse.umbc.edu/robucci/cmpeRSD/Lectures/Lecture12__ManagingMetaStability/)
  - [robucci cmpeRSD Lecture13__TimingAnalysis](https://eclipse.umbc.edu/robucci/cmpeRSD/Lectures/Lecture13__TimingAnalysis/)
  - [robucci cmpeRSD applets/timing_violations](https://covail.cs.umbc.edu/robucci/applets/timing_violations/)
- semiconshorts
  - [setup-and-hold-time](https://semiconshorts.com/2022/12/31/setup-and-hold-time/)
  - [multicycle-path](https://semiconshorts.com/2022/07/07/multicycle-path/)
- Intel
  - https://www.intel.cn/content/www/cn/zh/docs/programmable/683068/18-1/the-timing-netlist.html
- AMD
  - https://docs.amd.com/r/en-US/ug906-vivado-design-analysis/Timing-Analysis
- RealDigital
  - [Delays & Glitches](https://www.realdigital.org/doc/2025b9b47aa04aa159c9e79d530ff7ff)
    - [Delay of Combinational Circuits](https://www.realdigital.org/doc/e0a5d48a7ec1903720ebd9f9f707e1a0)
    - [Timing Issues of Digital Circuits](https://www.realdigital.org/doc/ff991122c4d78b897d96b4091f65eb31)
    - [Inertial Delay](https://www.realdigital.org/doc/3fb0871857596559b1365c9d7b473784)

---

## Comments

### konosubakonoakua · 2025-09-14T13:11:51Z

## deepseek

<details>

<summary> 用一个非常直观的比喻来解释 FPGA 时序约束。</summary>

**核心思想：一场精心策划的接力赛**：

想象一下，**FPGA 内部数据的传输就像一场在多个站点之间进行的接力赛**。

*   **寄存器 (Register)** = **接力站**。数据就像运动员，必须在特定的时间点（时钟信号的上升沿）到达接力站，并从那里出发前往下一站。
*   **时钟 (Clock)** = **发令枪**。整个比赛的节奏由发令枪控制。每一声枪响（时钟沿），所有站点的运动员同时：
    1.  **交接数据**：本站的运动员将接力棒（数据）交给下一站的运动员。
    2.  **准备出发**：下一站的运动员拿到棒后，立刻开始奔跑（数据传输），目标是在下一声枪响前准时到达再下一个站点。
*   **组合逻辑 (Combinational Logic)** = **两站之间的跑道**。这是运动员实际奔跑的路径。路径可能很长（逻辑层级多）、很复杂（路径上有许多障碍和弯道，即各种逻辑门），导致奔跑时间变长。
*   **时序约束 (Timing Constraints)** = **比赛规则和裁判**。你作为教练（设计者），需要告诉裁判（开发工具）你对这场比赛的要求，以确保它能顺利进行。

---

### 最重要的两条时序约束（比赛规则）

为了让比赛不出错，有两个最关键的规则：

#### 1. 建立时间 (Setup Time) - `Tsu`
**定义**：在发令枪响（时钟沿）之前，接力棒（数据）必须**提前多久**稳稳地交到下一站运动员手中。
**直观解释**：下一站的运动员需要一点时间来稳住身子、看清来者、做好准备接棒。这个准备时间就是建立时间。如果棒子来得太晚，在他还没准备好时就到了，他可能接不住，导致掉棒（数据错误）。

**约束名称**：**`周期约束`** 或 **`时钟约束`**。这是最基础的约束，你告诉裁判：“我的发令枪每隔 `X` 纳秒响一次（时钟周期），请确保所有运动员都能在这个时间间隔内跑完他们的路程！”


*上图的关键点：数据必须在时钟沿到来之前的 `Tsu` 时间窗口内保持稳定和有效。*

#### 2. 保持时间 (Hold Time) - `Th`
**定义**：在发令枪响（时钟沿）之后，接力棒（数据）必须**继续稳定多久**，不能立刻撤走。
**直观解释**：下一站的运动员接棒后，需要一点点时间来抓牢棒子。如果上一站的运动员在枪响后立刻把棒子抽走（数据变化太快），可能会导致接棒的运动员失手（数据错误）。

**约束名称**：通常由工具自动保证，但在高速设计或特殊情况下也需要关注。周期约束隐含了对保持时间的要求。


*上图的关键点：数据在时钟沿到来之后，还必须继续稳定至少 `Th` 的时间，不能立刻变化。*

---

### 如果违反规则（时序违例）会怎样？

*   **建立时间违例 (Setup Violation)**：数据跑得太慢了，在发令枪响时还没到达下一站。
    *   **后果**：下一站寄存器没收到正确的数据，功能出错。
    *   **解决办法**：
        1.  **让发令枪慢点响**：降低时钟频率（增大周期约束的数值）。
        2.  **让运动员跑快点**：优化代码和逻辑，减少组合路径的延迟（例如，插入流水线、优化逻辑结构）。
        3.  **修一条更短更直的路**：让布局布线工具把相连的寄存器放得近一些（降低物理路径延迟）。

*   **保持时间违例 (Hold Violation)**：数据跑得太快了，在发令枪响后过早地发生了变化，影响了当前站点的捕获。
    *   **后果**：当前站点的寄存器捕获的数据不稳定，功能出错。
    *   **解决办法**：
        1.  **稍微拖延一下跑得快的运动员**：在数据路径上增加一点延迟（例如，插入缓冲区 Buffer）。
        2.  **调整接力站的位置**：通过布局布线控制。

### 其他常见约束（更多比赛规则）

*   **输入延迟 (Input Delay)**：你告诉裁判：“外面的运动员（芯片外部输入的数据）会在发令枪响前 `X` 纳秒到达我们第一个接力站的门口。” 这样裁判就知道该如何协调内部运动员和外部运动员的交接。
*   **输出延迟 (Output Delay)**：你告诉裁判：“我们最后一个接力站的运动员，必须在发令枪响后 `Y` 纳秒内把棒子交到场外裁判（外部芯片）手里。” 这样就能确保外部设备能可靠地接收到FPGA输出的数据。

### 总结

**FPGA时序约束的本质，就是把你对数字电路正常工作的“物理要求”（时间要求）明确地告诉开发软件（Quartus, Vivado等）。**

软件虽然能自动把你的代码变成电路，但它不知道你希望这个电路跑多快。你必须通过时序约束来设定目标：**“我的时钟是100MHz，请你想尽一切办法，确保数据在每一个时钟周期内都能稳定地传送到下一个寄存器！”**

然后，软件的布局布线工具就会像一个严格的裁判，努力地调整各个“接力站”的位置、优化“跑道”的路径，来满足你设定的所有规则。最后它会给你一份详细的“比赛报告”（时序报告），告诉你规则是否全部满足。如果没有（时序违例），你就需要修改设计或约束，直到满足为止。

所以，**不加时序约束的设计就像是让运动员在无规则的比赛中乱跑，即使偶尔能跑对，也绝对不可靠。** 而**加了时序约束**，就相当于为比赛制定了清晰的规则，工具会全力保障你的设计在指定的速度下**稳定可靠**地运行。

---


“建立时间”不是一个工程师凭空发明的概念，而是**由构成数字电路的物理器件（主要是MOSFET）的固有特性所决定的**。它本质上是一个**物理限制**。

我们可以从两个层面来理解它的物理支撑：**晶体管开关需要时间** 和 **实际电路是一个模拟世界**。

---

### 1. 核心物理原理：晶体管开关不是瞬间完成的

寄存器（D触发器）的核心是传输门（由MOSFET构成）和反相器。MOS管导通和截止都需要时间。

当时钟沿到来，要求传输门打开，让输入数据D端的电压值被捕获到触发器内部。这个“捕获”过程，实际上是**对一个电容进行充电或放电**，使其电压达到代表0或1的正确电平。

*   **这个电容是什么？** 是触发器内部节点固有的寄生电容（以及负载）。
*   **充电/放电需要什么？** 需要电流和**时间**。

**建立时间的物理意义就是：为了保证在时钟沿到来时，这个充电/放电过程能够有足够的时间完成到一个稳定的、正确的电平。**

---

### 2. 一个更直观的比喻：用相机拍摄高速运动的物体

你可以把D触发器捕获数据的过程，想象成**用一台老式的旋转快门相机（时钟信号）拍摄一辆高速行驶的赛车（数据信号）**。

*   **目标**：拍一张清晰不模糊的照片（捕获一个稳定的数据值‘0’或‘1’）。
*   **快门按下瞬间** = **时钟上升沿**。
*   **赛车速度/位置** = **数据信号的电压值**。

**为什么需要建立时间？**

相机的快门不是瞬间完全打开的，它有一个开启的过程。如果在快门即将完全打开的瞬间，赛车还在飞速移动，那么最终拍到的照片就会是**模糊的**——你无法判断它到底是0还是1，这就是**亚稳态**。



为了拍出清晰的照片，你必须**在快门完全打开之前，就让赛车已经到达预定位置并保持静止**。

*   **`建立时间 (Tsu)`** 就是要求“赛车”必须**在快门完全打开前**的一段时间就就位并保持稳定。这样，当快门完全打开时，它才能被清晰地记录下来。
*   **`保持时间 (Th)`** 就是要求“赛车”在**快门完全打开后**的一小段时间内也不能移动。这是为了防止它过早开走，导致照片后半部分拍到的又是模糊的移动影像。

**如果你违反了建立时间（赛车来得太晚），相机就会在“半开半闭”的状态下捕捉到一个正在变化、模糊不清的图像（亚稳态）。**

---

### 从模拟波形角度看

让我们看一个真实的信号波形，这是最直接的物理体现：



假设D触发器的逻辑门限是中间那条虚线电压。

- **情况A（满足建立时间）**：在时钟沿到来前，数据信号（蓝色）已经稳定了**足够长的时间（Tsu）** 在了一个有效的逻辑电平（高电平‘1’）。当时钟沿（红色）到来时，内部电路有充足的时间完成切换，输出Q会稳定地变为‘1’。
- **情况B（违反建立时间）**：在时钟沿到来时，数据信号仍然在**上升过程中**，处于一个**非高非低的中间模拟电压**。这个电压可能不足以让内部晶体管完全导通或截止。导致的结果是：
    1.  输出Q需要**非常长的时间**才能缓慢地稳定到一个确定的高电平或低电平（** metastability**）。
    2.  甚至可能**振荡**。
    3.  更糟糕的是，后续电路把这个不稳定的值当作有效数据读取，导致整个系统功能错误。

### 总结

所以，建立时间的物理支撑来自于：

1.  **finite switching speed**：MOS晶体管和逻辑门的开关速度不是无限的，它们需要时间对负载电容进行充放电。
2.  **analog nature of digital circuits**：在微观层面，数字电路本质上是模拟的。电压不能瞬间跳变，而是有一个上升/下降的模拟过程。建立时间就是为了避开这个模拟变化的区域，确保采样时信号处于一个安全的“数字”区域（高电平或低电平）。
3.  **prevention of metastability**：最终极的目的，就是避免寄存器进入一个非0非1的亚稳态，从而导致系统失败。

因此，建立时间不是一种“设计选择”，而是一个必须遵守的**物理规律**。时序约束就是我们告诉开发工具这个物理规律的数值是多少，让工具来确保我们的设计满足它。

</details>
